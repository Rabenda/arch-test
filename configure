#!/usr/bin/perl -w

open MAKEFILE, "<Makefile";
{undef local $/; $_=<MAKEFILE>}
close MAKEFILE;

/^ARCHS=((?:[a-z0-9-]| |\t|\\\n)*)/m
    or die "Couldn't parse ARCHS= in the Makefile\n";
$ARCH{$_}=1 for($1=~/[a-z0-9-]+/g);
my @FOUND;

while (/^arch-test-([a-z0-9-]+):.*\n\t([a-z0-9_.-]+-(?:gcc|as))/mg)
{
    $ARCH{$1} or die "Error: $1 known but not listed.\n";
    delete $ARCH{$1};
    `which $2`;
    if ($?)
    {
        print "Missing $1: $2 not installed\n";
    }
    else
    {
        print "$1: $2\n";
        push @FOUND, "$1";
    }
}

die "Error: ".join(' ',keys %ARCH)." listed but not known.\n" if (%ARCH);

open CONFIG, ">config";
print CONFIG "ARCHS=@FOUND\n";
